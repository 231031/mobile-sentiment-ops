name: Deploy MLOps Stack

on:
  push:
    branches:
      - xxx # Your main branch

jobs:
  build:
    name: Build and Push Images
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    steps:
      - name: clean unncessary files to save space
        run: |
          docker image prune -f
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d
          sudo apt -y autoremove --purge
          sudo apt -y autoclean
          sudo apt clean
          rm --recursive --force "$AGENT_TOOLSDIRECTORY"

      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set Docker tag output (short SHA with timestamp)
        id: set_tag
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="$SHORT_SHA-$TIMESTAMP"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # --- NEW: Build both services ---
      - name: Build backend and frontend images
        id: build-images
        run: |
          # This command builds 'backend' and 'frontend' services
          # It creates local images named 'mlops_backend:latest' and 'mlops_frontend:latest'
          docker compose -p mlops -f ./docker-compose.test.yml build backend frontend

      # --- NEW: Tag both services ---
      - name: Tag images
        run: |
          # Tag Backend
          docker tag mlops_backend:latest ghcr.io/${{ github.repository }}/mlops_mbs_backend:latest
          docker tag mlops_backend:latest ghcr.io/${{ github.repository }}/mlops_mbs_backend:${{ steps.set_tag.outputs.tag }}

          # Tag Frontend
          docker tag mlops_frontend:latest ghcr.io/${{ github.repository }}/mlops_mbs_frontend:latest
          docker tag mlops_frontend:latest ghcr.io/${{ github.repository }}/mlops_mbs_frontend:${{ steps.set_tag.outputs.tag }}

      # --- NEW: Push all 4 tags ---
      - name: Push images to GitHub Container Registry
        run: |
          # Push Backend
          docker push ghcr.io/${{ github.repository }}/mlops_mbs_backend:latest
          docker push ghcr.io/${{ github.repository }}/mlops_mbs_backend:${{ steps.set_tag.outputs.tag }}

          # Push Frontend
          docker push ghcr.io/${{ github.repository }}/mlops_mbs_frontend:latest
          docker push ghcr.io/${{ github.repository }}/mlops_mbs_frontend:${{ steps.set_tag.outputs.tag }}

    outputs:
      docker_tag: ${{ steps.set_tag.outputs.tag }} 

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: self-hosted
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- UPDATED: Create .env file for deployment ---
      - name: Create .env file
        working-directory: ./
        run: |
          # This creates the .env file from scratch with all required values
          echo 'GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}' > .env
          echo 'GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' >> .env
          echo 'GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}' >> .env
          echo 'AIRFLOW__WEBSERVER__BASE_URL=${{ vars.AIRFLOW__WEBSERVER__BASE_URL }}' >> .env
          echo 'AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX=${{ vars.AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX }}' >> .env
          echo 'AIRFLOW_UID=${{ vars.AIRFLOW_UID }}' >> .env
          echo 'MLFLOW_TRACKING_URI=${{ vars.MLFLOW_TRACKING_URI }}' >> .env
          echo 'REPORTS_DIR=${{ vars.REPORTS_DIR }}' >> .env
          echo 'INITIAL_DATA_PATH=${{ vars.INITIAL_DATA_PATH }}' >> .env
          echo 'DOCKER_TAG=${{ needs.build.outputs.docker_tag }}' >> .env
          echo 'VITE_API_URL=${{ vars.VITE_API_URL }}' >> .env
          # echo 'POSTGRES_USER=${{ secrets.POSTGRES_USER }}' >> .env
          # echo 'POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}' >> .env
          # echo 'POSTGRES_DB=${{ secrets.POSTGRES_DB }}' >> .env
          # echo 'POSTGRE_NAME=${{ secrets.POSTGRE_NAME }}' >> .env
          # echo 'POSTGRE_HOST=${{ secrets.POSTGRE_HOST }}' >> .env
          # echo 'LABEL_STUDIO_USERNAME=${{ secrets.LABEL_STUDIO_USERNAME }}' >> .env
          # echo 'LABEL_STUDIO_PASSWORD=${{ secrets.LABEL_STUDIO_PASSWORD }}' >> .env
          # echo 'LABEL_STUDIO_DISABLE_SIGNUP_WITHOUT_LINK=${{ secrets.LABEL_STUDIO_DISABLE_SIGNUP_WITHOUT_LINK }}' >> .env
      
      - name: Create credential.json file
        working-directory: ./app
        run: |
          echo '${{ secrets.CREDENTIAL }}' > credential.json
              
      # --- UPDATED: Use docker-compose.prod.yml ---
      - name: Delete old docker container
        run: docker compose -p mlops -f docker-compose.prod.yml down -v

      - name: Deploy to server
        working-directory: ./
        run: |
          # This command is now correct!
          # It pulls the new backend/frontend images using the DOCKER_TAG from the .env file
          docker compose -p mlops -f docker-compose.prod.yml pull backend frontend
          
          # This brings up the entire stack, including the new images
          docker compose -p mlops -f docker-compose.prod.yml up -d

      # --- UPDATED: Better check and cleanup ---
      - name: Check and Delete unused images
        run: |
          sleep 5
          echo "Checking running containers for project 'mlops'..."
          
          # This command checks if services 'backend' and 'frontend' are in a 'running' state
          if docker compose -p mlops -f docker-compose.prod.yml ps --status running | grep 'backend'; then
            
            echo "Containers are running successfully. Proceeding to cleanup..."
            # This is the safest way to remove old, unused images
            docker image prune -f
          
          else
            echo "Deployment check failed: Containers not running. Skipping image cleanup."
            docker compose -p mlops -f docker-compose.prod.yml ps
            exit 1
          fi